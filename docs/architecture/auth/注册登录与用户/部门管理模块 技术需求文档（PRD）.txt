下面是**面向开发人员、可直接落地实现**的《**注册登录与用户/部门管理模块 技术需求文档（PRD）**》。
本版本**只输出需求文档（不含接口文档）**，严格区分**前端 / 后端职责**，并在每个功能中给出**实现逻辑 + 功能细节 + 边界条件 + 安全性设计**。

> 模块归属：`auth`
> 适配架构：Spring Boot 单体 + DDD 分层 + 前后端分离
> 权限模型：RBAC + 部门树 + 职级（经理 / 主管 / 普通员工）

---

# 注册登录与用户/部门管理模块 PRD

（Auth & User & Department）

---

## 一、模块概述（Overview）

### 1. 模块定位

本模块负责系统中**用户身份管理、认证授权、部门组织结构管理**，是整个 bid-doc-system 的**基础模块**，为 Folder / Document / Workflow 等模块提供统一的身份与权限基础。

### 2. 核心目标

* 支持 **用户自主注册**（需绑定部门）
* 支持 **部门树结构（一级 / 二级）**
* 支持 **部门内职级角色（经理 / 主管 / 普通员工）**
* 提供 **安全、可审计、可扩展**的登录鉴权能力
* 为后续 **微服务拆分（用户中心）**提供良好结构

---

## 二、核心概念定义（Domain Glossary）

| 概念             | 说明                      |
| -------------- | ----------------------- |
| 用户（User）       | 系统使用者，隶属于某一部门           |
| 部门（Department） | 组织结构节点，仅支持两级            |
| 职级（JobLevel）   | 经理 / 主管 / 普通员工          |
| 系统角色（Role）     | RBAC 权限角色（如 ADMIN、USER） |
| 登录主体           | User + JWT Token        |

---

## 三、部门模型设计（Department）

### 3.1 部门结构规则

* **仅支持两级**

  * 一级部门（如：市场部、技术管理室）
  * 二级部门（如：市场支持一室）
* **不允许三级**
* 用户**必须归属到二级部门**
* 一个部门下：

  * 最多 **1 个经理**
  * 可有多个主管
  * 普通员工无限制

---

## 四、功能清单（功能名总览）

| 功能名     | 功能编号         |
| ------- | ------------ |
| 部门树管理   | AUTH-DEP-01  |
| 用户注册    | AUTH-USER-01 |
| 用户登录    | AUTH-USER-02 |
| 用户管理    | AUTH-USER-03 |
| 职级与角色管理 | AUTH-ROLE-01 |
| 安全与风控   | AUTH-SEC-01  |

---

# 五、功能详细需求说明

---

## 功能 AUTH-DEP-01：部门树管理

### 1. 功能概述

用于维护系统的组织结构，为用户注册、权限控制、流程审批提供基础数据。

### 2. 需求描述

* 支持创建、编辑、停用部门
* 支持部门树结构展示
* 限制层级深度为 2
* 部门可设置负责人（经理）

### 3. 页面设计（前端）

**页面：部门管理页**

* 树形结构（左）
* 详情编辑区（右）

字段展示：

* 部门名称
* 部门级别（一级 / 二级）
* 上级部门
* 部门经理
* 状态（启用 / 停用）

### 4. 用户旅程

> 管理员 → 部门管理 → 新建一级部门 → 新建二级部门 → 指定经理

### 5. 用户故事

> 作为系统管理员，我希望维护公司部门结构，以便员工注册时正确归属部门。

### 6. 实现逻辑（后端）

* `Department` 作为**独立聚合根**
* 创建部门时：

  * 校验父部门是否存在
  * 若 parent_id ≠ null，则父部门必须为一级
* 删除部门：

  * 若部门下存在用户 → 禁止删除
* 停用部门：

  * 允许，但新用户不可注册到该部门

### 7. 功能细节 & 边界条件

| 场景       | 处理方式           |
| -------- | -------------- |
| 创建三级部门   | 拒绝             |
| 删除含用户的部门 | 拒绝             |
| 停用部门     | 用户仍可登录，但不可新增用户 |
| 指定经理     | 一个部门仅允许一个经理    |

### 8. 前后端分工

**前端**

* 树形渲染
* 表单校验
* 禁止非法层级操作

**后端**

* 层级规则校验
* 数据完整性校验
* 事务控制

---

## 功能 AUTH-USER-01：用户注册

### 1. 功能概述

允许用户自主注册账号，绑定部门与职级，注册后需管理员审核或默认启用（配置项）。

---

### 2. 注册信息设计（重点）

#### 必填信息（必须）

| 字段   | 说明           | 原因       |
| ---- | ------------ | -------- |
| 用户名  | 登录名          | 唯一身份     |
| 密码   | BCrypt 加密    | 安全       |
| 姓名   | 真实姓名         | 审计 / 流程  |
| 手机号  | 联系方式         | 通知 / 找回  |
| 邮箱   | 企业邮箱         | 通知 / 唯一性 |
| 一级部门 | 选择           | 组织归属     |
| 二级部门 | 选择           | 精确归属     |
| 职级   | 经理 / 主管 / 员工 | 权限与流程    |

#### 非必填信息

* 工号
* 备注说明

---

### 3. 页面设计（前端）

**页面：用户注册页**

步骤：

1. 填写基本信息
2. 选择部门（级联）
3. 选择职级
4. 提交注册

前端校验：

* 密码强度
* 邮箱格式
* 部门必须选到二级

---

### 4. 用户旅程

> 新用户 → 注册 → 填写信息 → 提交 → 等待审核 → 可登录

---

### 5. 用户故事

> 作为新员工，我希望能自行注册账号并选择所属部门，减少人工创建成本。

---

### 6. 实现逻辑（后端）

1. 校验用户名 / 邮箱唯一性
2. 校验部门合法性（必须二级）
3. 校验职级合法性
4. 密码 BCrypt 加密
5. 用户状态初始化为：

   * `PENDING`（需审核）或
   * `ACTIVE`（直接可用）

---

### 7. 功能细节 & 边界条件

| 场景        | 行为 |
| --------- | -- |
| 注册到停用部门   | 拒绝 |
| 注册经理但已有经理 | 拒绝 |
| 重复邮箱      | 拒绝 |
| 弱密码       | 拒绝 |

---

### 8. 前后端分工

**前端**

* 表单交互
* 密码强度提示
* 部门级联选择

**后端**

* 所有规则最终校验
* 密码加密
* 用户状态管理

---

## 功能 AUTH-USER-02：用户登录

### 1. 功能概述

提供基于 JWT 的安全登录能力。

### 2. 实现逻辑

1. 用户提交用户名 + 密码
2. 校验用户状态（ACTIVE）
3. 校验密码
4. 生成 JWT（含 userId / role / deptId）
5. 返回 Token

---

### 3. 功能细节

| 校验项      | 说明    |
| -------- | ----- |
| 用户不存在    | 返回错误  |
| 密码错误     | 返回错误  |
| 用户被禁用    | 禁止登录  |
| Token 过期 | 需重新登录 |

---

### 4. 安全设计

* 登录失败次数限制
* Token 过期时间
* Refresh Token（可选）

---

## 功能 AUTH-USER-03：用户管理

### 功能点

* 查询用户列表
* 启用 / 禁用用户
* 修改用户部门（需管理员）
* 修改职级

---

## 功能 AUTH-ROLE-01：职级与角色管理

### 职级（业务语义）

* 经理
* 主管
* 普通员工

### 系统角色（技术权限）

* ADMIN
* USER

> 职级 ≠ 角色
> 职级影响**业务流程**，角色影响**接口权限**

---

## 功能 AUTH-SEC-01：安全与健全性设计

### 安全要求

* 密码 BCrypt
* JWT 防篡改
* 接口权限拦截
* 操作审计（结合 audit 模块）

### 数据一致性

* 用户与部门强关联
* 禁止“孤立用户”

---

# 六、需求文档总结

本模块设计重点在于：

* **组织结构清晰**
* **权限模型可扩展**
* **安全边界明确**
* **支持后续微服务拆分**


